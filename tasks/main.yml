---
- name: Display all variables/facts known for a host
  debug:
    var: libvirt_host_networks
  register: myresults

- name: validate variables are defined
  include_tasks: verify_variables.yml

- name: validate virtualization extensions are available to this host
  include_tasks: validate.yml
  when: not cicd_test|bool

- name: ensure required packages are installed
  become: yes
  shell: >
    rpm -q "{{ item }}" || yum install -y "{{ item }}" && echo yes
  args:
    warn: false
  loop: "{{ required_rpm_pakcages }}"
  register: pkg_installed
  changed_when: pkg_installed.stdout == 'yes'

- name: configure shell extras
  include_tasks: configure_shell.yml
  when: configure_shell|bool

- name: enable libvirt services
  become: yes
  service:
    name: "{{ item }}"
    enabled: yes
    state: started
  with_items: "{{ libvirt_services }}"

- name: Add user to libvirt group
  become: yes
  user:
    name: "{{ admin_user }}"
    groups: libvirt,qemu
    append: yes

- name: Allow non-root users to libvirt unix_sock_group
  become: yes
  lineinfile:
    dest: /etc/libvirt/libvirtd.conf
    regexp: '^#\s*unix_sock_group.*$'
    line: 'unix_sock_group = "libvirt"'
  notify: Reload libvirtd service

- name: Allow non-root users to libvirt unix_sock_rw_perms
  become: yes
  lineinfile:
    dest: /etc/libvirt/libvirtd.conf
    regexp: '^#\s*unix_sock_rw_perms.*$'
    line: 'unix_sock_rw_perms = "0770"'
  notify: Reload libvirtd service

- name: Allow non-root users to libvirt unix_sock_admin_perms
  become: yes
  lineinfile:
    dest: /etc/libvirt/libvirtd.conf
    regexp: '^#\s*unix_sock_admin_perms.*$'
    line: 'unix_sock_admin_perms = "0700"'
  notify: Reload libvirtd service

- name: start tuned profile virtual-host
  become: yes
  shell: |
   set -o pipefail &&  tuned-adm profile virtual-host
  register: start_tuned
  changed_when: start_tuned.rc != 0
  args:
    executable: /bin/bash

- name: configure bridge interface for libvirt
  include_tasks: bridge_interface.yml
  #when: configure_bridge
  loop: "{{ libvirt_host_networks }}"
  loop_control:
    index_var: type_idx
    loop_var: bridge_item
  when: (bridge_item.mode == 'bridge' and  not cicd_test|bool)

- name: configure libvirt network
  loop: "{{ libvirt_host_networks }}"
  loop_control:
    index_var: libvirt_idx
    loop_var: libvirt_item
  include_tasks: networks.yml
  when: not cicd_test|bool

- name: configure libvirt storage pool
  include_tasks: storage_pool.yml
  when: not cicd_test|bool

#- name: copy qcow image to machine    #this task is deprecated and should be remove 12/28/20
#  include_tasks: copy_qcow_image.yml
#  when: not cicd_test|bool

- name: install cockpit
  become: yes
  package:
    name: "{{ cockpit_packages }}"
    state: present
  ignore_errors: yes

- name: enable cockpit service
  become: yes
  service:
    name: cockpit
    enabled: yes
    state: started

- name: enable firewall ports for cockpit
  become: yes
  firewalld:
    service: cockpit
    permanent: yes
    state: enabled
  when: not cicd_test|bool

#- name: Flush handlers
#  meta: flush_handlers
